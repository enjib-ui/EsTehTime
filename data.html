<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Penjualan</title>
<style>
  body { font-family:'Segoe UI',sans-serif; background:#f4f7fa; margin:0; padding:20px; }
  h2 { text-align:center; color:#333; }
  table { width:100%; border-collapse:collapse; margin-top:20px; background:#fff;
          border-radius:10px; overflow:hidden; box-shadow:0 3px 20px rgba(0,0,0,0.05); }
  th, td { border:1px solid #ddd; padding:12px 15px; text-align:center; }
  th { background-color:#7E97A6; color:white; }
  tr:nth-child(even) { background-color:#f9f9f9; }
  tfoot td { font-weight:bold; background:#e2e2e2; }
  .btn-clear, .btn-delete, .btn-pdf { display:block; padding:5px 10px; border:none;
               border-radius:5px; cursor:pointer; font-weight:bold; transition:0.3s; }
  .btn-clear { background-color:#e74c3c; color:white; margin:20px auto; }
  .btn-clear:hover { background-color:#c0392b; }
  .btn-delete { background-color:#e74c3c; color:white; }
  .btn-delete:hover { background-color:#c0392b; }
  .btn-pdf { background-color:#3498db; color:white; margin:10px auto; }
  .btn-pdf:hover { background-color:#2980b9; }
</style>
</head>
<body>

<h2>Data Penjualan Es Teh Time</h2>

<table id="dataTable">
  <thead>
    <tr>
      <th>No</th>
      <th>Tanggal</th>
      <th>Nominal (Rp)</th>
      <th>Aksi</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="2">Total</td>
      <td id="totalNominal">Rp 0</td>
      <td></td>
    </tr>
  </tfoot>
</table>

<button class="btn-pdf" id="exportPDF">Ekspor ke PDF</button>
<button class="btn-clear" id="clearData">Hapus Semua Data</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
import jsPDF from "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js";
import "https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.js";

const firebaseConfig = {
  apiKey: "AIzaSyAv2KN1pHrUPTMaNL2bXF39NI8S2iN2TWw",
  authDomain: "estehtime.firebaseapp.com",
  projectId: "estehtime",
  storageBucket: "estehtime.firebasestorage.app",
  messagingSenderId: "185336920733",
  appId: "1:185336920733:web:b0d09bdc8724ac80763274"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tbody = document.querySelector('#dataTable tbody');
const totalNominalEl = document.getElementById('totalNominal');

let penjualanData = [];

function parseNominal(value) {
  if (typeof value === 'number') return value;
  if (!value) return 0;
  const num = parseFloat(value.toString().replace(/[^0-9]/g, ''));
  return isNaN(num) ? 0 : num;
}

async function loadData() {
  tbody.innerHTML = '<tr><td colspan="4">Memuat data...</td></tr>';
  totalNominalEl.textContent = 'Rp 0';
  penjualanData = [];

  try {
    const snapshot = await getDocs(collection(db, "penjualan"));
    tbody.innerHTML = '';

    if (snapshot.empty) {
      tbody.innerHTML = '<tr><td colspan="4">Belum ada data tersimpan.</td></tr>';
      return;
    }

    let index = 1;
    let total = 0;

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const tanggal = data.tanggal || docSnap.id;
      const nominal = parseNominal(data.nominal);

      total += nominal;

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${index}</td>
        <td>${tanggal}</td>
        <td>Rp ${nominal.toLocaleString('id-ID')}</td>
        <td><button class="btn-delete">Hapus</button></td>
      `;
      tbody.appendChild(row);

      row.querySelector('.btn-delete').addEventListener('click', async () => {
        if (!confirm(`Hapus data tanggal ${tanggal}?`)) return;
        try {
          await deleteDoc(doc(db, "penjualan", docSnap.id));
          alert("✅ Data berhasil dihapus!");
          loadData();
        } catch (err) {
          alert("❌ Gagal menghapus data: " + err.message);
          console.error(err);
        }
      });

      penjualanData.push([index, tanggal, `Rp ${nominal.toLocaleString('id-ID')}`]);
      index++;
    });

    totalNominalEl.textContent = 'Rp ' + total.toLocaleString('id-ID');

  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="4">Gagal memuat data: ${err.message}</td></tr>`;
    console.error(err);
  }
}

// Hapus semua data
document.getElementById('clearData').addEventListener('click', async () => {
  if (!confirm('Yakin ingin menghapus semua data?')) return;
  try {
    const snapshot = await getDocs(collection(db, "penjualan"));
    const deletePromises = snapshot.docs.map(d => deleteDoc(doc(db, "penjualan", d.id)));
    await Promise.all(deletePromises);
    alert("✅ Semua data berhasil dihapus!");
    loadData();
  } catch (err) {
    alert("❌ Gagal menghapus data: " + err.message);
    console.error(err);
  }
});

// Ekspor PDF multi-halaman
document.getElementById('exportPDF').addEventListener('click', () => {
  if (!penjualanData.length) return alert("Tidak ada data untuk diekspor!");

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt');

  doc.setFontSize(16);
  doc.text("Data Penjualan Es Teh Time", 40, 40);
  doc.setFontSize(10);
  const now = new Date();
  doc.text("Tanggal Cetak: " + now.toLocaleDateString('id-ID'), 40, 55);

  doc.autoTable({
    startY: 70,
    head: [['No', 'Tanggal', 'Nominal (Rp)']],
    body: penjualanData,
    foot: [['', 'Total', totalNominalEl.textContent]],
    theme: 'grid',
    styles: { fontSize: 10 },
    headStyles: { fillColor: [126,151,166] },
    footStyles: { fillColor: [226,226,226] },
    didDrawPage: (data) => {
      // Header di setiap halaman
      if (data.pageNumber > 1) {
        doc.setFontSize(16);
        doc.text("Data Penjualan Es Teh Time", 40, 40);
        doc.setFontSize(10);
        doc.text("Tanggal Cetak: " + now.toLocaleDateString('id-ID'), 40, 55);
      }
    },
    margin: { top: 70 }
  });

  doc.save('Data_Penjualan.pdf');
});

loadData();
</script>

</body>
</html>
